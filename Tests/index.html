<script>
    
    const webSocketURL = 'ws://localhost:3000';
    const userPassword = 'abc123.';
    var webSocket = null;
    var code = 0;

    function connect () {
        webSocket = new WebSocket(webSocketURL);
        webSocket.onopen = () => {
            //webSocket.send('*** Nueva conexiÃ³n ***')
            var id;
            newIdentity().then(
                id => {
                    console.log('=> Signon');
                    signon(id);
                    console.log('=> Good login');
                    login(id);
                    console.log('=> Login: bad id');
                    login('aaaaaaaaaa');
                    console.log('=> Login: no id');
                    login(null);
                }
            );

        }
        webSocket.onmessage = msg => {
            console.log(msg)
        }
    }
    connect();

    async function newIdentity () {
        return crypto.subtle.digest("SHA-512",new TextEncoder("utf-8").encode(`${crypto.getRandomValues(new Uint32Array(10))}:${userPassword}`)).then(hash=>btoa(String.fromCharCode(...new Uint8Array(hash))))
    }

    async function signon (id) {
        const request = {
            code: code++,
            obj: {
                msgType: 'signon',
                nameHash: id,
            }
        }
        webSocket.send(JSON.stringify(request));
    }

    async function login (nameHash) {
        const request = {
            code: code++,
            obj: {
                msgType: 'login',
                nameHash: nameHash,
            },
        }
        webSocket.send(JSON.stringify(request));
    }

</script>